// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Installation {
  id              Int              @id @unique @default(autoincrement())
  installation_id Int              @unique @default(autoincrement())
  platform        Platform
  organization    Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  Int?
  token           String
  expiration      String
  type            InstallationType @default(individual)
}

model Organization {
  id            Int            @id @unique @default(autoincrement())
  name          String
  users         User[]
  roles         UserRole[]
  repositories  Repository[]
  installations Installation[]
}

model Email {
  id       Int     @id @unique @default(autoincrement())
  name     String  @unique
  verified Boolean @default(false)
  primary  Boolean @default(false)
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int
}

model GithubUserAuthorization {
  id     Int    @id @unique @default(autoincrement())
  token  String
  user   User   @relation(fields: [userId], references: [id])
  userId Int    @unique
}

model User {
  id            Int                      @id @unique @default(autoincrement())
  name          String
  emails        Email[]
  roles         UserRole[]
  organizations Organization[]
  github        GithubUserAuthorization?
  overallStats  UserStats[]
  monthlyStats  MonthlyStats[]
  pullRequests  PullRequest[]
}

model UserRole {
  id             Int          @id @unique @default(autoincrement())
  userId         Int
  organizationId Int
  role           Role
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Repository {
  id             Int           @id @unique @default(autoincrement())
  name           String
  html_url       String
  description    String        @default("")
  language       String        @default("Unknown Language")
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform       Platform
  api_url        String
  platform_id    Int
  clone_url      String
  tracked        Boolean       @default(false)
  created_at     String
  updated_at     String
  totalLines     Int           @default(0)
  totalCommits   Int           @default(0)
  userStats      UserStats[]
  pullRequests   PullRequest[]

  @@unique([platform_id, platform])
}

model UserStats {
  id           Int        @id @unique @default(autoincrement())
  email        String
  totalLines   Int
  totalCommits Int
  repositoryId Int
  repository   Repository @relation(fields: [repositoryId], references: [id])
  userId       Int
  user         User       @relation(fields: [userId], references: [id])
}

model MonthlyStats {
  id      Int      @id @unique @default(autoincrement())
  user    User     @relation(fields: [userId], references: [id])
  userId  Int
  lines   Int      @default(0)
  commits Int      @default(0)
  date    DateTime @default(now())
}

model PullRequest {
  id           Int               @id @unique @default(autoincrement())
  date         DateTime
  author       User              @relation(fields: [authorId], references: [id])
  authorId     Int
  status       PullRequestStatus
  repositoryId Int
  repository   Repository        @relation(fields: [repositoryId], references: [id])
  description  String
}

enum PullRequestStatus {
  open
  merged
  inreview
  declined
}

enum Role {
  admin
  manager
  viewer
}

enum Platform {
  github
  bitbucket
}

enum InstallationType {
  individual
  organization
}

enum RequestMethod {
  GET
  POST
}
